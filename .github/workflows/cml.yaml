name: cml-matrix
on: [push, pull_request]

permissions:
  contents: write

jobs:
  train_eval:
    name: Train & Evaluate (${{ matrix.experiment }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        experiment: [rf_small, rf_big, logreg]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - uses: iterative/setup-cml@v2

      - name: Prepare folders
        run: mkdir -p models reports metrics

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train (${{ matrix.experiment }})
        run: |
          python src/train.py --exp-name "${{ matrix.experiment }}"

      - name: Evaluate (${{ matrix.experiment }})
        run: |
          python src/evaluate.py --exp-name "${{ matrix.experiment }}"

      - name: Upload artifacts (${{ matrix.experiment }})
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.experiment }}
          if-no-files-found: ignore
          path: |
            models/${{ matrix.experiment }}_model.pkl
            metrics/${{ matrix.experiment }}.json
            reports/${{ matrix.experiment }}_confusion_matrix.png
            reports/${{ matrix.experiment }}_feature_importance.png

  report:
    name: CML Report
    runs-on: ubuntu-latest
    needs: train_eval
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - uses: iterative/setup-cml@v2

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: .

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Gather files & compare
        run: |
          set -euo pipefail
          mkdir -p models reports metrics
          shopt -s nullglob
          for d in artifacts-*; do
            mv "$d"/* . || true
          done
          python src/compare.py

      - name: Build CML report (multi-exp)
        run: |
          set -euo pipefail; set +H
          {
            printf '## Iris Experiments Report\n\n'
            printf 'This comment was generated by CML and GitHub Actions using a matrix of experiments.\n\n'

            for f in metrics/*.json; do
              exp=$(basename "$f" .json)
              printf '### Experiment: %s\n\n' "$exp"
              printf '**Metrics**\n\n```json\n'
              cat "$f"
              printf '\n```\n\n'
              cm="reports/${exp}_confusion_matrix.png"
              if [ -f "$cm" ]; then
                printf '**Confusion Matrix**\n\n![inline](%s)\n\n' "$cm"
              fi
              fiimg="reports/${exp}_feature_importance.png"
              if [ -f "$fiimg" ]; then
                printf '**Feature Importance**\n\n![inline](%s)\n\n' "$fiimg"
              fi
            done

            if [ -f reports/comparison_accuracy.png ]; then
              printf '## Comparison Across Experiments\n\n'
              printf 'Overall accuracy comparison.\n\n'
              printf '![inline](%s)\n\n' 'reports/comparison_accuracy.png'
            fi
            if [ -f best_model.json ]; then
              printf '## Best Model\n\n```json\n'
              cat best_model.json
              printf '\n```\n\n'
            fi
          } > report.md

      - name: Post CML comment
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: cml comment create --target="commit/$GITHUB_SHA" report.md



        
